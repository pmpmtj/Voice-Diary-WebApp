{% extends 'scheduler_control/base.html' %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <h2 class="mb-4">System Status</h2>
            
            <!-- Email Configuration Card -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Email Configuration</h5>
                    <form id="emailConfigForm">
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="sendDemoEmail" 
                                       {% if email_config.send_demo_email %}checked{% endif %}>
                                <label class="form-check-label" for="sendDemoEmail">Send Demo Email</label>
                            </div>
                        </div>
                        
                        <div id="emailFields" style="display: {% if email_config.send_demo_email %}block{% else %}none{% endif %};">
                            <div class="mb-3">
                                <label for="emailTo" class="form-label">Recipient Email</label>
                                <input type="email" class="form-control" id="emailTo" 
                                       value="{{ email_config.email.to }}" required>
                            </div>
                            <div class="mb-3">
                                <label for="emailSubject" class="form-label">Subject</label>
                                <input type="text" class="form-control" id="emailSubject" 
                                       value="{{ email_config.email.subject }}" required>
                            </div>
                            <div class="mb-3">
                                <label for="emailMessage" class="form-label">Message</label>
                                <textarea class="form-control" id="emailMessage" rows="3" required>{{ email_config.email.message }}</textarea>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Save Email Configuration</button>
                    </form>
                </div>
            </div>

            <!-- Status Card -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Current Status</h5>
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <span class="badge {% if status.is_running %}bg-success{% else %}bg-danger{% endif %}">
                                {{ status.is_running|yesno:"Running,Stopped" }}
                            </span>
                        </div>
                        <div>
                            {% if status.is_running %}
                                <p class="mb-0">Started: {{ status.last_started|date:"Y-m-d H:i:s" }}</p>
                            {% else %}
                                <p class="mb-0">Stopped: {{ status.last_stopped|date:"Y-m-d H:i:s" }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Schedule Card -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Schedule</h5>
                    <p class="card-text">
                        Runs per day: {{ config.runs_per_day }}
                    </p>
                    <p class="card-text">
                        Interval: {{ config.interval }}
                    </p>
                </div>
            </div>

            <!-- Recent Activity Card -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Recent Activity</h5>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Action</th>
                                    <th>Status</th>
                                    <th>User</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in logs %}
                                <tr>
                                    <td>{{ log.timestamp|date:"Y-m-d H:i:s" }}</td>
                                    <td>{{ log.action }}</td>
                                    <td>
                                        <span class="badge {% if log.success %}bg-success{% else %}bg-danger{% endif %}">
                                            {{ log.success|yesno:"Success,Failed" }}
                                        </span>
                                    </td>
                                    <td>{{ log.user.username }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center">No recent activity</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Auto-refresh status every 30 seconds
    setInterval(function() {
        fetch('{% url "get_status" %}')
            .then(response => response.json())
            .then(data => {
                const statusBadge = document.querySelector('.badge');
                if (statusBadge) {
                    statusBadge.textContent = data.is_running ? 'Running' : 'Stopped';
                    statusBadge.className = `badge ${data.is_running ? 'bg-success' : 'bg-danger'}`;
                }
            });
    }, 30000);

    // Email configuration form handling
    document.getElementById('sendDemoEmail').addEventListener('change', function() {
        document.getElementById('emailFields').style.display = this.checked ? 'block' : 'none';
    });

    document.getElementById('emailConfigForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = {
            email: {
                to: document.getElementById('emailTo').value,
                subject: document.getElementById('emailSubject').value,
                message: document.getElementById('emailMessage').value
            },
            send_demo_email: document.getElementById('sendDemoEmail').checked
        };

        fetch('{% url "update_email_config" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Email configuration updated successfully');
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error updating email configuration');
            console.error('Error:', error);
        });
    });
</script>
{% endblock %} 